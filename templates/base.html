<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}StockMaster - Inventory Management{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='stockmaster-ui.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
</head>
<body>
    {% if current_user.is_authenticated %}
    <!-- Top Navigation Bar -->
    <nav class="navbar-custom">
        <div style="display: flex; align-items: center; width: 100%;">
            <div class="navbar-brand">
                <i class="bi bi-box-seam"></i> StockMaster
            </div>
            
            <div style="display: flex; gap: 0.5rem;">
                <a href="{{ url_for('dashboard') }}" class="nav-link {% if request.endpoint == 'dashboard' %}active{% endif %}">
                    Dashboard
                </a>
                <a href="{{ url_for('receipts') }}" class="nav-link {% if request.endpoint in ['receipts', 'receipt_detail', 'receipt_create'] %}active{% endif %}">
                    Operations
                </a>
                <a href="{{ url_for('products') }}" class="nav-link {% if request.endpoint in ['products', 'product_detail', 'product_create', 'product_edit'] %}active{% endif %}">
                    Products
                </a>
                <a href="{{ url_for('ledger') }}" class="nav-link {% if request.endpoint == 'ledger' %}active{% endif %}">
                    Move History
                </a>
                <a href="{{ url_for('settings') }}" class="nav-link {% if request.endpoint in ['settings', 'warehouses', 'warehouse_detail', 'warehouse_create', 'warehouse_edit', 'categories', 'category_create', 'category_edit', 'partners', 'partner_detail', 'partner_create', 'partner_edit'] %}active{% endif %}">
                    Settings
                </a>
            </div>
            
            <div style="margin-left: auto; display: flex; align-items: center; gap: 1rem;">
                <span class="nav-item-icon" title="Search" style="cursor: pointer;">
                    <i class="bi bi-search"></i>
                </span>
                
                <!-- Notifications Bell -->
                <div style="position: relative; display: inline-block;">
                    <a href="{{ url_for('notifications') }}" class="nav-item-icon" title="Notifications" style="text-decoration: none; position: relative;">
                        <i class="bi bi-bell"></i>
                        <span id="unread-count" class="notification-badge" style="display: none; position: absolute; top: -5px; right: -8px; background: #ff6b6b; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: bold;">0</span>
                    </a>
                    
                    <!-- Notifications Dropdown -->
                    <div id="notifications-dropdown" style="display: none; position: absolute; right: 0; top: 100%; background: white; border: 1px solid #dee2e6; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); width: 350px; max-height: 400px; overflow-y: auto; margin-top: 0.5rem; z-index: 1000;">
                        <div style="padding: 1rem; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa;">
                            <h4 style="margin: 0; font-size: 1rem;">Notifications</h4>
                            <a href="{{ url_for('notifications') }}" style="color: #4dabf7; text-decoration: none; font-size: 0.9rem;">View All</a>
                        </div>
                        <div id="notifications-list" style="max-height: 300px; overflow-y: auto;"></div>
                        <div style="padding: 1rem; text-align: center; border-top: 1px solid #dee2e6; background: #f8f9fa;">
                            <a href="{{ url_for('notifications') }}" style="color: #4dabf7; text-decoration: none; font-weight: 500;">See All Notifications →</a>
                        </div>
                    </div>
                </div>
                
                <span class="nav-item-icon" title="User Menu" style="cursor: pointer;">
                    <i class="bi bi-person-circle"></i>
                </span>
                <a href="{{ url_for('logout') }}" class="nav-item-icon" title="Logout" style="text-decoration: none; cursor: pointer;">
                    <i class="bi bi-box-arrow-right"></i>
                </a>
            </div>
        </div>
    </nav>
    {% endif %}

    <!-- Main Content -->
    <div class="main-content">
        <!-- Flash Messages (only for authenticated users) -->
        {% if current_user.is_authenticated %}
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div style="background-color: {% if category == 'error' %}#f8d7da{% elif category == 'success' %}#d4edda{% else %}#d1ecf1{% endif %}; border: 1px solid {% if category == 'error' %}#f5c6cb{% elif category == 'success' %}#c3e6cb{% else %}#bee5eb{% endif %}; color: {% if category == 'error' %}#721c24{% elif category == 'success' %}#155724{% else %}#0c5460{% endif %}; padding: 0.75rem 1.25rem; border-radius: 8px; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                        <span>{{ message }}</span>
                        <button onclick="this.parentElement.style.display='none';" style="background: none; border: none; color: inherit; cursor: pointer; font-size: 1.25rem; padding: 0;">×</button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        {% endif %}
        
        {% block content %}{% endblock %}
    </div>
    
    <script src="{{ url_for('static', filename='stockmaster-ui.js') }}"></script>
    
    <!-- Notification System -->
    <script>
    // Toggle notification dropdown
    document.querySelector('.bi-bell')?.parentElement?.addEventListener('click', function(e) {
        e.preventDefault();
        const dropdown = document.getElementById('notifications-dropdown');
        dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        const dropdown = document.getElementById('notifications-dropdown');
        const bellIcon = document.querySelector('.bi-bell')?.parentElement;
        if (bellIcon && !bellIcon.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });

    // Load notifications periodically
    function loadNotifications() {
        fetch('{{ url_for('api_unread_notifications_count') }}')
            .then(response => response.json())
            .then(data => {
                const badge = document.getElementById('unread-count');
                if (data.count > 0) {
                    badge.textContent = data.count > 99 ? '99+' : data.count;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
            });

        fetch('{{ url_for('api_recent_notifications') }}')
            .then(response => response.json())
            .then(data => {
                const list = document.getElementById('notifications-list');
                if (data.notifications.length > 0) {
                    list.innerHTML = data.notifications.map(n => `
                        <a href="${n.url}" style="display: block; padding: 0.75rem 1rem; border-bottom: 1px solid #f0f0f0; text-decoration: none; color: inherit; transition: all 0.2s; ${n.is_read ? 'background: white;' : 'background: #e7f5ff;'} cursor: pointer;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: #1a1a2e; margin-bottom: 0.2rem;">${n.title}</div>
                                    <div style="font-size: 0.85rem; color: #666; line-height: 1.3;">${n.message.substring(0, 50)}...</div>
                                    <div style="font-size: 0.75rem; color: #999; margin-top: 0.3rem;">${n.created_at}</div>
                                </div>
                                ${!n.is_read ? '<span style="width: 8px; height: 8px; background: #4dabf7; border-radius: 50%; flex-shrink: 0; margin-left: 0.5rem; margin-top: 0.2rem;"></span>' : ''}
                            </div>
                        </a>
                    `).join('');
                } else {
                    list.innerHTML = '<div style="padding: 2rem 1rem; text-align: center; color: #999;">No new notifications</div>';
                }
            });
    }

    // Initial load and periodic refresh
    if (document.querySelector('.bi-bell')) {
        loadNotifications();
        setInterval(loadNotifications, 30000); // Refresh every 30 seconds
    }
    </script>
    
    {% block scripts %}{% endblock %}
</body>
</html>

