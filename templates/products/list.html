{% extends "base.html" %}

{% block title %}Stock - StockMaster{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h2 style="color: #003366; font-weight: 600; margin: 0;"><i class="bi bi-box"></i> Stock</h2>
    <div style="display: flex; gap: 1rem; align-items: center;">
        <a href="{{ url_for('product_create') }}" class="btn btn-success">
            <i class="bi bi-plus-lg"></i> Add Product
        </a>
        <span class="nav-item-icon" title="Search" style="margin-left: 0; cursor: pointer;">
            <i class="bi bi-search"></i>
        </span>
    </div>
</div>

<!-- Filters -->
<form method="GET" class="mb-3" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
    <input type="text" class="form-control" name="search" placeholder="Search by name or SKU" value="{{ search }}">
    <select class="form-select" name="category_id">
        <option value="">All Categories</option>
        {% for cat in categories %}
        <option value="{{ cat.id }}" {% if category_id == cat.id %}selected{% endif %}>{{ cat.name }}</option>
        {% endfor %}
    </select>
    <div style="display: flex; gap: 0.5rem;">
        <button type="submit" class="btn btn-primary">Filter</button>
        <a href="{{ url_for('products') }}" class="btn btn-outline-primary">Clear</a>
    </div>
</form>

<!-- Stock Table -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Sale Price</th>
                        <th>On Hand</th>
                        <th>Free to Use</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for product in products %}
                    <tr {% if product.low_stock %}style="background-color: #fff3cd;"{% endif %}>
                        <td style="font-weight: 500;">{{ product.name }}</td>
                        <td>
                            {% if product.sale_price is not none %}
                                Rs. {{ '%.2f'|format(product.sale_price) }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td data-editable="stock" style="cursor: pointer; padding: 1rem; border-radius: 4px; transition: background-color 0.2s;">
                            {{ product.total_stock }}
                        </td>
                        <td data-available="{{ product.total_stock }}" style="font-weight: 600; color: #003366;">
                            {{ product.total_stock }}
                        </td>
                        <td>
                            {% if product.low_stock %}
                            <span class="badge" style="background-color: #ffc107; color: #333;">Low Stock</span>
                            {% elif product.total_stock <= 0 %}
                            <span class="badge" style="background-color: #dc3545; color: white;">Out of Stock</span>
                            {% else %}
                            <span class="badge" style="background-color: #28a745; color: white;">In Stock</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('product_detail', id=product.id) }}" class="btn btn-sm btn-primary" style="margin-right: 0.5rem;">
                                <i class="bi bi-eye"></i> View
                            </a>
                            <a href="{{ url_for('product_edit', id=product.id) }}" class="btn btn-sm btn-primary">
                                <i class="bi bi-pencil"></i> Edit
                            </a>
                            {% if current_user.role == 'inventory_manager' %}
                            <button class="btn btn-sm btn-outline-secondary btn-edit-price" data-id="{{ product.id }}" style="margin-left: 0.4rem;">
                                <i class="bi bi-currency-exchange"></i> Price
                            </button>
                            <a href="{{ url_for('product_price_history', id=product.id) }}" class="btn btn-sm btn-outline-info" style="margin-left: 0.4rem;">
                                <i class="bi bi-clock-history"></i>
                            </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center text-muted" style="padding: 2rem;">No products found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<p class="text-muted" style="margin-top: 1.5rem; text-align: center;">User must be able to update the stock from here.</p>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function(){
    document.querySelectorAll('.btn-edit-price').forEach(function(btn){
        btn.addEventListener('click', function(){
            const id = this.dataset.id;
            const newSale = prompt('Enter new sale price (numbers only)');
            if(newSale === null) return;
            const newCost = prompt('Enter new cost price (numbers only)');
            if(newCost === null) return;

            fetch(`/products/${id}/price-update`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({sale_price: newSale, cost_price: newCost})
            }).then(r=>r.json()).then(data=>{
                if(data.success){
                    alert('Price updated');
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Unknown'));
                }
            }).catch(err=>{ alert('Request failed') });
        });
    });
});
</script>
{% endblock %}

